name: branch-target-policy

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-branch-target:
    runs-on: ubuntu-latest
    steps:
      - name: Debug PR refs
        run: |
          SRC="${{ github.event.pull_request.head.ref }}"
          BASE="${{ github.event.pull_request.base.ref }}"
          echo "Computed SRC: '$SRC'"
          echo "Computed BASE: '$BASE'"

          # RULE → main accepts only qa
          if [[ "$BASE" == "main" && "$SRC" != "qa" ]]; then
            echo "ERROR: main accepts only PRs from 'qa'. Source: $SRC"
            exit 1
          fi

          # RULE → qa accepts only dev
          if [[ "$BASE" == "qa" && "$SRC" != "dev" ]]; then
            echo "ERROR: qa accepts only PRs from 'dev'. Source: $SRC"
            exit 1
          fi

          # RULE → dev accepts only int_dev
          if [[ "$BASE" == "dev" && "$SRC" != "int_dev" ]]; then
            echo "ERROR: dev accepts only PRs from 'int_dev'. Source: $SRC"
            exit 1
          fi

          # RULE → TOPOS-* must target int_dev
          if [[ "$SRC" == TOPOS-* && "$BASE" != "int_dev" ]]; then
            echo "ERROR: TOPOS-* must target 'int_dev'. Source: $SRC Target: $BASE"
            exit 1
          fi

          echo "OK: branch-target-policy passed."
